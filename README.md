# @nmi-agro/rvo-connector

A client library for connecting to RVO (Rijksdienst voor Ondernemend Nederland) webservices to exchange agricultural data. This package simplifies the process of making API calls for services like `OpvragenBedrijfspercelen` using either ABA (username/password) or TVS (OAuth2) authentication.

## Features

- Supports both ABA (Username/Password) and TVS (OAuth2) authentication.
- Handles the TVS OAuth2 token acquisition and refresh flow.
- Provides a simple interface for fetching `Bedrijfspercelen`.
- Automates XML request building and response parsing.

## Installation

```bash
npm install @nmi-agro/rvo-connector
```

## Usage

### 1. Initialization

First, import and instantiate the `Client`. You need to provide configuration for the authentication method(s) you intend to use.

```javascript
const RvoConnector = require('@nmi-agro/rvo-connector');
const fs = require('fs');

// It's recommended to load credentials from environment variables
const client = new RvoConnector({
    aba: {
        username: process.env.RVO_ABA_USERNAME,
        password: process.env.RVO_ABA_PASSWORD,
    },
    tvs: {
        clientId: process.env.RVO_TVS_CLIENT_ID,
        privateKey: fs.readFileSync(process.env.RVO_TVS_PRIVATE_KEY_PATH, 'utf8'),
        redirectUri: process.env.RVO_TVS_REDIRECT_URI,
        scope: 'dpr.opvragenbedrijfspercelen', // Example scope
    }
});
```

### 2. Authentication

#### ABA

Authentication is handled automatically when you make a request with `method: 'ABA'`. No extra steps are needed.

#### TVS (OAuth2)

The TVS flow requires a one-time user interaction to get an authorization code. Your application must handle this.

##### Step A: Get the Authorization URL

Redirect the user to the URL generated by `getAuthorizationUrl()`.

```javascript
const { url, state } = client.getAuthorizationUrl();
console.log('Please direct the user to this URL:', url);
// In a web application, you would typically do:
// res.redirect(url);
```

##### Step B: Exchange the Authorization Code for Tokens

After the user authorizes the application, they will be redirected back to your `redirectUri` with a `code` in the query string. Exchange this code for tokens.

```javascript
const authorizationCode = '... code from the redirect query string ...';

try {
    const tokenData = await client.exchangeAuthCodeForTokens(authorizationCode);
    console.log('Successfully obtained tokens:', tokenData);
    // The client now internally stores the access and refresh tokens.
    // You can persist `tokenData.refresh_token` for future sessions.
} catch (error) {
    console.error('Failed to get tokens:', error);
}
```

*Note: The client will automatically handle refreshing the access token as long as it has a valid refresh token.*

### 3. Fetching Bedrijfspercelen

Once the client is configured (and for TVS, authenticated), you can call `getBedrijfspercelen`.

#### Using ABA

```javascript
async function getPercelenWithABA() {
    try {
        const percelenData = await client.getBedrijfspercelen({
            method: 'ABA',
            farmId: '123456789' // The KVK-nummer of the farm
        });
        console.log('Bedrijfspercelen (ABA):', JSON.stringify(percelenData, null, 2));
    } catch (error) {
        console.error('Error fetching percelen with ABA:', error);
    }
}

getPercelenWithABA();
```

#### Using TVS

```javascript
async function getPercelenWithTVS() {
    try {
        const percelenData = await client.getBedrijfspercelen({
            method: 'TVS',
            farmId: '987654321' // The KVK-nummer of the farm
        });
        console.log('Bedrijfspercelen (TVS):', JSON.stringify(percelenData, null, 2));
    } catch (error) {
        console.error('Error fetching percelen with TVS:', error);
    }
}

// Ensure you have authenticated and have tokens before calling
getPercelenWithTVS();
```

## API Reference

### `new RvoConnector(options)`

Creates a new client instance.

- `options.aba`: Configuration for ABA.
  - `username`: ABA username.
  - `password`: ABA password.
- `options.tvs`: Configuration for TVS.
  - `clientId`, `privateKey`, `redirectUri`, `scope`.
  - `accessToken` (optional): An existing access token.
  - `refreshToken` (optional): An existing refresh token to enable automatic renewals.

### `getAuthorizationUrl()`

Returns `{ url, state }` for the TVS OAuth2 flow.

### `exchangeAuthCodeForTokens(code)`

Exchanges a TVS authorization code for an access token and refresh token. The client stores these tokens internally for subsequent requests.

### `getBedrijfspercelen({ method, farmId })`

Fetches the `Bedrijfspercelen` for a given farm.

- `method`: `'ABA'` or `'TVS'`.
- `farmId` (optional): The farm ID (e.g., KVK-nummer) to query.

## Error Handling

The library will throw specific errors for failed API calls or authentication issues. It's recommended to wrap API calls in a `try...catch` block to handle these potential errors gracefully.

## License

MIT
